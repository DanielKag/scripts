# !/bin/sh

echo " _          _                       _      _    "
echo "| |        | |                     | |    | |   "
echo "| | ___   _| |__   ___     ___  ___| | ___| | __"
echo "| |/ / | | | '_ \\ / _ \\   / __|/ _ \\ |/ _ \\ |/ /"
echo "|   <| |_| | |_) |  __/   \\__ \\  __/ |  __/   < "
echo "|_|\\_\\\\__,_|_.__/ \___|   |___/\\___|_|\\___|_|\\_\\ v1.5"

FZF_DEFAULT_OPTS='--bind esc:abort --reverse'

usecontext() {
  context=$(parsecontexta $1)
  echo 'kubectl config use-context $context'
 
}

# Move to config file
namespaces_list='tb-viewer\nsite-assets\nviewer-server\nci' 

dc=$(kubectl config get-contexts | sort -r \
      | fzf --color 16 --height=~20 \
            --header-lines 1 \
            --tiebreak begin \
            --bind "space:execute(kubectl config use-context {1} &>/dev/null)" \
            --bind "space:+reload(kubectl config get-contexts | sort -r)" \
            --bind "space:+first" \
            --header $'<Space> - Use context' \
            --prompt "Select DC: " \
                | tr -s ' ' | cut -d ' ' -f 2)


if [ -z "$dc" ]; then
  echo "No DC selected"
  exit 0
fi


namespace=$(printf $namespaces_list | fzf --color 16 --sync --height 10 \
                                          --bind "tab:+reload(kubectl get ns -o name --context $dc | cut -d/ -f2)" \
                                          --header $'<Tab> - Load all namespaces' \
                                          --prompt "Select namespace: ")
if [ -z "$namespace" ]; then
  echo "No namespace selected"
  exit 0 
fi

describe_cmd="echo '{1}"

header=$'↑/↓ - Select, <Shift>+↑/↓ - Scroll describe\n<Tab> - Toggle describe\n<Enter> - SSH to the pod\n<Esc> - Cancel'

pod_name=$(kubectl get pods -o wide -L version -n $namespace --context $dc \
             | fzf --header-lines 1 \
                --ansi --exact \
                --prompt "Select pod: " \
                --header "$header" \
                --bind='tab:toggle-preview' \
                --preview-window down \
                --preview-window hidden \
                --border rounded \
                --color 16,border:#333333,preview-fg:#32afff \
                --preview "kubectl describe pod -n $namespace {1}" \
                    | cut -d\  -f 1)

if [ -n "$pod_name" ]; then
  kubectl exec -it -n $namespace $pod_name -- bash
fi


